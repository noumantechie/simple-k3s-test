name: Deploy to K3s

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ğŸ¯ Target Environment'
        required: true
        type: choice
        options:
          - testing
          - qa

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: ğŸ” Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets[format('KUBECONFIG_{0}', github.event.inputs.environment)] }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: ğŸš€ Apply Manifests (Namespace Only)
        run: |
          NS=${{ github.event.inputs.environment }}

          echo "Deploying to namespace: $NS"
          kubectl apply -n $NS -f k8s/service.yaml
          kubectl apply -n $NS -f k8s/deployment.yaml

      - name: â³ Wait for Rollout
        run: |
          NS=${{ github.event.inputs.environment }}
          kubectl rollout status deployment/nginx -n $NS --timeout=3m

      - name: ğŸ“Š Pod & Service Status
        run: |
          NS=${{ github.event.inputs.environment }}

          echo "### Pods" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n $NS >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          echo "### Services" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get svc -n $NS >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ¥ Health Check
        run: |
          NS=${{ github.event.inputs.environment }}

          kubectl wait --for=condition=ready pod -l app=nginx -n $NS --timeout=2m
